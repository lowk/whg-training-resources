"use strict";(self.webpackChunkwhg_training_resources=self.webpackChunkwhg_training_resources||[]).push([[9314],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>g});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=o.createContext({}),m=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=m(e.components);return o.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},h=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),h=m(n),g=a,d=h["".concat(l,".").concat(g)]||h[g]||u[g]||r;return n?o.createElement(d,i(i({ref:t},p),{},{components:n})):o.createElement(d,i({ref:t},p))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var m=2;m<r;m++)i[m]=n[m];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}h.displayName="MDXCreateElement"},3327:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>m});var o=n(7462),a=(n(7294),n(3905));const r={sidebar_position:7},i="Memory issues and how to solve them",s={unversionedId:"programming/programming_with_gene_annotations/Memory_issues_and_how_to_solve_them",id:"programming/programming_with_gene_annotations/Memory_issues_and_how_to_solve_them",title:"Memory issues and how to solve them",description:"Up to table of contents",source:"@site/docs/programming/programming_with_gene_annotations/Memory_issues_and_how_to_solve_them.md",sourceDirName:"programming/programming_with_gene_annotations",slug:"/programming/programming_with_gene_annotations/Memory_issues_and_how_to_solve_them",permalink:"/whg-training-resources/programming/programming_with_gene_annotations/Memory_issues_and_how_to_solve_them",draft:!1,editUrl:"https://github.com/whg-training/whg-training-resources/edit/main/docs/programming/programming_with_gene_annotations/Memory_issues_and_how_to_solve_them.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"Counting genes I",permalink:"/whg-training-resources/programming/programming_with_gene_annotations/Counting_genes_1"},next:{title:"Counting genes II: types of protein-coding genes",permalink:"/whg-training-resources/programming/programming_with_gene_annotations/Counting_genes_2"}},l={},m=[{value:"Some solutions",id:"some-solutions",level:3},{value:"Memory vs. performance",id:"memory-vs-performance",level:3},{value:"Implications",id:"implications",level:3},{value:"Memory use challenge",id:"memory-use-challenge",level:3}],p={toc:m};function u(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,o.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"memory-issues-and-how-to-solve-them"},"Memory issues and how to solve them"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"/whg-training-resources/programming/programming_with_gene_annotations/"},"Up to table of contents")),(0,a.kt)("p",null,"So far in this tutorial we haven't thought much about memory (computer memory that is), or how best\nwe should use it. We've used python and pandas to implement our code, because that was easy and\ngave us high-level features. And we haven't done anything special to keep memory usage low or work\non performance."),(0,a.kt)("p",null,"Unfortunately the data volumes used in many bioinformatics analyses are so large, this approach can\nfall over quite quickly. And indeed if I use ",(0,a.kt)("a",{target:"_blank",href:n(2114).Z},"version 2 of my code"),"] to\nload the gene annotations:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'import gff\ndata = gff.parse_gff3_to_dataframe("Homo_sapiens.GRCh38.104.chr.gff3" )\n')),(0,a.kt)("p",null,"I find that the process is taking over 3.5Gb of RAM. (My laptop has 16Gb, so this still runs, but\nif the data was any larger, it would start to fail.)"),(0,a.kt)("p",null,"Moreover, seemingly innocuous changes to the code can make large differences to the memory usage.\nMy two versions of ",(0,a.kt)("inlineCode",{parentName:"p"},"gff.py")," - ",(0,a.kt)("a",{target:"_blank",href:n(2343).Z},"version 1")," and ",(0,a.kt)("a",{target:"_blank",href:n(2114).Z},"version 2")," - do almost the same thing. The second one was tweaked to add a couple\nof extra columns. But it turns out to use about 4 times the memory."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Question.")," How much memory does your version of the code use? (To find out, run the above in one\nterminal, then in a second terminal run ",(0,a.kt)("inlineCode",{parentName:"p"},"top -u <username> -o RES")," (linux) or ",(0,a.kt)("inlineCode",{parentName:"p"},"top -U <username> -o\nmem")," (Mac OS). You should see your program climbing the rankings as it loads the data."),(0,a.kt)("h3",{id:"some-solutions"},"Some solutions"),(0,a.kt)("p",null,"The main ways to solve this type of problem are:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"work with data subsets (specific genome regions, specific record types, smaller organisms, or work in chunks)."),(0,a.kt)("li",{parentName:"ol"},"use memory-efficient data structures."),(0,a.kt)("li",{parentName:"ol"},"use things like sqlite that allow efficient access to on-disk data."),(0,a.kt)("li",{parentName:"ol"},"write code more carefully to control memory usage.")),(0,a.kt)("p",null,"In our problem we can exploit 1 and 3 by loading data directly from the sqlite database. (This of\ncourse assumes your ",(0,a.kt)("inlineCode",{parentName:"p"},"gff_to_sqlite.py")," program didn't run out of memory.)  That is we can write:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'import pandas, sqlite3\ndb = sqlite3.connect( "genes.sqlite" )\ndata = pandas.read_sql( "SELECT * FROM gff_data WHERE type == \'gene\'", db )\n')),(0,a.kt)("p",null,"Because this loads only the 'genes' records, it uses much less memory."),(0,a.kt)("p",null,"Another thing we can do is try to improve the code. If you ",(0,a.kt)("a",{parentName:"p",href:"/whg-training-resources/programming/programming_with_gene_annotations/What_gene_annotation_data_looks_like"},"look at the input\nfile")," for a moment you'll realise that a huge proportion\nof the actual data is in that ",(0,a.kt)("inlineCode",{parentName:"p"},"attributes")," field. That's the one we have to work hardest with to\nparse. Not surprisingly, what we do with this field really matters in terms of memory usage. The\nkey difference between my two versions of the ",(0,a.kt)("inlineCode",{parentName:"p"},"parse_gff3_to_dataframe()")," function is that ",(0,a.kt)("a",{target:"_blank",href:n(2114).Z},"the second version")," creates a variable that stores all the unpacked attributes:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"    attributes = result['attributes'].apply( parse_attributes )\n")),(0,a.kt)("p",null,"This one line turns out to use up about 2.5Gb of memory!"),(0,a.kt)("p",null,"In ",(0,a.kt)("a",{target:"_blank",href:n(531).Z},"solutions/part2/gff_lowmem.py")," is one possible solution to this.\nInstead of fully parsing the whole attribute string (which has a load of stuff we don't care\nabout), this version uses ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Regular_expression"},"regular expressions"),"\n(implemented in the ",(0,a.kt)("a",{parentName:"p",href:"https://docs.python.org/3/library/re.html"},"python re module"),") to parse out the\nfields of interest. And then uses the same regular expression to remove the field from the\nattributes. The crucial point here, however, is not the regular expressions themselves (which are\njust a tool to do the parsing) but the fact that the data is never copied around. This version is\nback down to < 2Gb of memory."),(0,a.kt)("h3",{id:"memory-vs-performance"},"Memory vs. performance"),(0,a.kt)("p",null,"Funnily enough this version is also almost twice as fast as the version not using regular\nexpression! This is not really surprising either, because the regular expression library is highly\noptimised; and our original ",(0,a.kt)("inlineCode",{parentName:"p"},"parse_attributes()")," version was pretty simple and spent quite a bit of\ntime splitting up fields (and allocating memory for them) that were never used."),(0,a.kt)("h3",{id:"implications"},"Implications"),(0,a.kt)("p",null,"Considerations like this mean we need to add a fourth item to our list of coding aims for\nbioinformatics:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"it ought to work"),(0,a.kt)("li",{parentName:"ul"},"it ought to not take too long to do it"),(0,a.kt)("li",{parentName:"ul"},"it ought to be obvious what it does"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"it ought not to waste memory"))),(0,a.kt)("h3",{id:"memory-use-challenge"},"Memory use challenge"),(0,a.kt)("p",null,"In fact our program ",(0,a.kt)("inlineCode",{parentName:"p"},"gff_to_sqlite.py")," does not need to use much memory at all. If you would like\nan additional challenge, try this one:"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Advanced challenge:")," write a version of ",(0,a.kt)("inlineCode",{parentName:"p"},"gff_to_sqlite.py")," that has low memory usage."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Hints"),":"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"The program could process rows one at a time, instead of loading them all in at the top.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"The ",(0,a.kt)("a",{parentName:"p",href:"gff_to_sqlite_python_version.py"},"the pure python version")," is a good place to look for the\nneeded sql statements.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"To make this slick, you should aim to commit the rows to the database in chunks (say of 10,000 rows). Then call\n",(0,a.kt)("inlineCode",{parentName:"p"},"db.commit()")," after each chunk to write the data.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Don't forget to ",(0,a.kt)("inlineCode",{parentName:"p"},"db.commit()")," after the last chunk"))),(0,a.kt)("p",null,"My version is ",(0,a.kt)("a",{target:"_blank",href:n(5911).Z},"here"),"."),(0,a.kt)("p",null,"Is this version faster or slower than the original?"),(0,a.kt)("p",null,"(An alternative might be to try to use ",(0,a.kt)("a",{parentName:"p",href:"https://pandas.pydata.org/docs/reference/api/pandas.read_table.html"},(0,a.kt)("inlineCode",{parentName:"a"},"chunksize")," in\n",(0,a.kt)("inlineCode",{parentName:"a"},"pandas.read_table()")),".) "),(0,a.kt)("p",null,"Now let's get ",(0,a.kt)("a",{parentName:"p",href:"/whg-training-resources/programming/programming_with_gene_annotations/Counting_genes_2"},"back to counting genes"),"."))}u.isMDXComponent=!0},5911:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/files/gff_to_sqlite-1c6689cbbc89f085d4d83a0092611f0c.py"},2343:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/files/gff-9fcbfd66dbcb2332cf0504d125cd9991.py"},2114:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/files/gff-6953e4a4db02bd87c9b8eae2a8a48610.py"},531:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/files/gff_lowmem-352e5e235348710d4bba7f7d14b44358.py"}}]);